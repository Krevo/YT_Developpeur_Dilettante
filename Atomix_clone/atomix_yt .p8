pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
-- atomix clone
-- par francois crevola

function _init()
	init_levels()
	init_cursor()
end

function _update()
	player_mvt()
end

function _draw()
	cls()
	map(0,0,0,0,128,64)
	for i,v in ipairs(levels[clevel]) do
		spr(v.sp, v.x*8, v.y*8)
	end
	spr(c.sp, c.x*8, c.y*8)
	if (win) then
		print("you win !", 2*8, 14*8, 11)
	end
end
-->8
function init_levels()
	clevel=1;
	levels={
		{
			{x=3, y=7, sp=4},
			{x=1, y=6, sp=5},
			{x=8, y=7, sp=6}	
		}
	}
	molecules={
		{
			{4,6,5}
		}
	}
	
end

function init_cursor()
	c = {
		x = 4,
		y = 6,
		sp = 7
	}
	selected = 0;
	win = false;
end

function atom_at(x,y)
	local a = 0
	for i,v in ipairs(levels[clevel]) do
		if (v.x==x and v.y==y) a=i
	end
	return a
end

function check_flag(flag,x,y)
	local sp=mget(x,y)
	return fget(sp,flag)
end

function max_move(dx,dy)
	local newx=c.x
	local newy=c.y
	local new_pos_ok=true
	if (selected==0 and check_pos(newx+dx,newy+dy)) then
		return newx+dx,newy+dy
	end
	while new_pos_ok do
		newx+=dx
		newy+=dy
		-- on teste la nvelle position
		new_pos_ok=check_pos(newx,newy)
	end
	newx-=dx
	newy-=dy
	return newx,newy
end

function check_pos(newx,newy)
	return (
		newy>=0 and newx>=0
  and not check_flag(0,newx,newy))
  and (selected==0
   or (selected>0
     and atom_at(newx,newy)==0
     and not check_flag(1,newx,newy))
	)
end

function player_mvt()
 local newx=c.x
 local newy=c.y
 local dx=0
 local dy=0
 if (btnp(➡️)) then dx=1
 elseif (btnp(⬅️)) then dx=-1
 elseif (btnp(⬆️)) then dy=-1
 elseif (btnp(⬇️)) then dy=1
 end
 if (btnp(❎)) then
 	local a = atom_at(c.x,c.y)
 	if (selected>0) then
 		c.sp = 7
 		selected = 0
 	else
 		if (a>0) then
 			c.sp = 8
 			selected = a
 		end
 	end
 end
 if (dx~=0 or dy~=0) then
 	newx, newy = max_move(dx, dy)
		c.x=newx
		c.y=newy
		if (selected>0) then
			levels[clevel][selected].x=newx
			levels[clevel][selected].y=newy
 	end
 	if is_winning(levels[clevel], molecules[clevel]) then
 		win = true;
		else
			win = false;
 	end
 end
end
-->8
function equal(ta, tb)
	if #ta ~= #tb then return false end
	for i,v in ipairs(ta) do
		if #ta[i] ~= #tb[i] then return false end
		for j,w in ipairs(ta[i]) do
			--print (ta[i][j].." = ".. tb[i][j].." ?")
			if ta[i][j] ~= tb[i][j] then return false end
		end		
	end
	return true
end

function find_min_max(t)
	local xmin = 99
	local xmax = 1
	local ymin = 99
	local ymax = 1
	for i,v in ipairs(t) do
		if (v.x < xmin) then xmin = v.x end
		if (v.x > xmax) then xmax = v.x end
		if (v.y < ymin) then ymin = v.y end
		if (v.y > ymax) then ymax = v.y end
	end
	return xmin,xmax,ymin,ymax
end

function create_table(nblignes, nbcols, initvalue)
	local t = {}
	for i = 1,nblignes,1 do
		t[i] = {}
		for j = 1,nbcols,1 do
			t[i][j] = initvalue
		end
	end
	return t
end

function place_atoms_in_table(t, atoms, xmin, ymin)
	for i,v in ipairs(atoms) do
		t[v.y-ymin+1][v.x-xmin+1] = v.sp
	end
end

function is_winning(atoms, cible)
	local xmin,xmax,ymin,ymax = find_min_max(atoms)
	local nblignes = (ymax-ymin)+1
	local nbcols = (xmax-xmin)+1
	local t = create_table(nblignes,nbcols,0)
	place_atoms_in_table(t, atoms, xmin, ymin)
	return equal(t, cible)
end

__gfx__
00000000777777772222222211111111000cc000000cc00000088000990000990090090000000000000000000000000000000000000000000000000000000000
0000000067777774222222221111111100cccc0000cccc0000888800900000090900009000000000000000000000000000000000000000000000000000000000
007007006677774422222222111111110cc7c7c00c7c7cc008877880000000009000000900000000000000000000000000000000000000000000000000000000
000770006667744422222222111111110cc777c77c777cc078788787000000000000000000000000000000000000000000000000000000000000000000000000
000770006666444422222222111111110cc7c7c77c7c7cc078788787000000000000000000000000000000000000000000000000000000000000000000000000
007007006665544422222222111111110cccccc00cccccc008877880000000009000000900000000000000000000000000000000000000000000000000000000
0000000066555544222222221111111100cccc0000cccc0000888800900000090900009000000000000000000000000000000000000000000000000000000000
00000000655555542222222211111111000cc000000cc00000088000990000990090090000000000000000000000000000000000000000000000000000000000
11111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11118888888888888888111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11180000000000000000811100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11118888888888888888111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002000300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020201030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020201010101010103030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020102020202020103030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010202020202020101030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102010202010201010201030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0102020202010201020201030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010201020201020201030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0301020202020202020201030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0301010101010101010101030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303101111111203030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303200406052203030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303303131313203030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0303030303030303030303030303030303030303030303030303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
